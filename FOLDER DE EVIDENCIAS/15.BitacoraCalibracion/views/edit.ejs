<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Registro - Bitácora de Calibración</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .campo-error {
            border: 3px solid #ff0000 !important;
            background-color: transparent !important;
        }
        .campo-error:focus {
            outline: 3px solid #ff0000 !important;
            background-color: transparent !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="titulo-principal">EDITAR REGISTRO DE CALIBRACIÓN</h1>
        
        <div class="formulario-container">
            <form action="/instrumentos/update/<%= instrumento.id %>" method="POST" class="formulario">
                <div class="form-group">
                    <label for="id_instrumento">ID Instrumento/Sensor:</label>
                    <input type="text" id="id_instrumento" name="id_instrumento" value="<%= instrumento.id_instrumento %>" required>
                </div>

                <div class="form-group">
                    <label for="ultima_calibracion">Última Calibración:</label>
                    <input type="date" id="ultima_calibracion" name="ultima_calibracion" value="<%= instrumento.ultima_calibracion.toISOString().split('T')[0] %>" required>
                </div>

                <div class="form-group">
                    <label for="fecha_calibracion_actual">Fecha Calibración Actual:</label>
                    <input type="date" id="fecha_calibracion_actual" name="fecha_calibracion_actual" value="<%= instrumento.fecha_calibracion_actual.toISOString().split('T')[0] %>" required>
                </div>

                <div class="form-group">
                    <label for="estandar_referencia">Estándar de Referencia:</label>
                    <input type="text" id="estandar_referencia" name="estandar_referencia" value="<%= instrumento.estandar_referencia %>" required>
                </div>

                <div class="form-group">
                    <label for="lectura_antes">Lectura Antes:</label>
                    <input type="text" id="lectura_antes" name="lectura_antes" value="<%= instrumento.lectura_antes %>" required>
                </div>

                <div class="form-group">
                    <label for="lectura_despues">Lectura Después:</label>
                    <input type="text" id="lectura_despues" name="lectura_despues" value="<%= instrumento.lectura_despues %>" required>
                </div>

                <div class="form-group">
                    <label for="certificado_asociado">Certificado Asociado:</label>
                    <input type="text" id="certificado_asociado" name="certificado_asociado" value="<%= instrumento.certificado_asociado %>" required>
                </div>

                <div class="form-group">
                    <label for="proxima_calibracion">Próxima Calibración:</label>
                    <input type="date" id="proxima_calibracion" name="proxima_calibracion" value="<%= instrumento.proxima_calibracion.toISOString().split('T')[0] %>" required>
                </div>

                <div class="botones-container">
                    <button type="submit" class="btn btn-guardar">ACTUALIZAR REGISTRO</button>
                    <a href="/" class="btn btn-volver">VOLVER</a>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Mostrar error del servidor si existe
        // @ts-ignore
        const errorServidor = <%- error ? JSON.stringify(error) : 'null' %>;
        if (errorServidor) {
            alert('ERROR:\n\n' + errorServidor.replace(/\|/g, '\n'));
        }
        
        // Función para detectar emojis
        function contieneEmojis(texto) {
            const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F1E0}-\u{1F1FF}\u{1F191}-\u{1F251}\u{1F004}\u{1F0CF}\u{1F170}-\u{1F171}\u{1F17E}-\u{1F17F}\u{1F18E}\u{3030}\u{2B50}\u{2B55}\u{2934}-\u{2935}\u{2B05}-\u{2B07}\u{2B1B}-\u{2B1C}\u{3297}\u{3299}\u{303D}\u{00A9}\u{00AE}\u{2122}\u{23F3}\u{24C2}\u{23E9}-\u{23EF}\u{25AA}-\u{25AB}\u{25B6}\u{25C0}\u{25FB}-\u{25FE}]/gu;
            return emojiRegex.test(texto);
        }
        
        // Función para validar caracteres permitidos
        function esTextoValido(texto) {
            const textoRegex = /^[a-zA-Z0-9\s\-\.°ºª()\/%ÁÉÍÓÚáéíóúÑñ]+$/;
            return textoRegex.test(texto);
        }
        
        // Función para validar scripts maliciosos
        function contieneScriptMalicioso(texto) {
            const scriptRegex = /<script|javascript:|onerror=|onclick=|onload=/gi;
            return scriptRegex.test(texto);
        }
        
        // Función para validar lectura
        function esLecturaValida(lectura) {
            const lecturaRegex = /^[0-9]+\.?[0-9]*\s*[a-zA-ZºªÁÉÍÓÚáéíóúÑñ°%\/\-]+$/;
            return lecturaRegex.test(lectura.trim());
        }
        
        // Función para validar certificado
        function esCertificadoValido(certificado) {
            const certRegex = /^[A-Z0-9\-]+$/i;
            return certRegex.test(certificado.trim());
        }
        
        // Función para marcar campo con error
        function marcarError(campoId, mensaje) {
            const campo = document.getElementById(campoId);
            campo.classList.add('campo-error');
            campo.focus();
            alert('ERROR EN ' + campo.placeholder + ':\n\n' + mensaje);
            return false;
        }
        
        // Función para limpiar marcas de error
        function limpiarErrores() {
            document.querySelectorAll('.campo-error').forEach(campo => {
                campo.classList.remove('campo-error');
            });
        }
        
        // Validar formulario
        document.querySelector('.formulario').addEventListener('submit', function(e) {
            e.preventDefault();
            limpiarErrores();
            
            const id_instrumento = document.getElementById('id_instrumento').value;
            const estandar_referencia = document.getElementById('estandar_referencia').value;
            const lectura_antes = document.getElementById('lectura_antes').value;
            const lectura_despues = document.getElementById('lectura_despues').value;
            const certificado_asociado = document.getElementById('certificado_asociado').value;
            const ultima_calibracion = document.getElementById('ultima_calibracion').value;
            const fecha_calibracion_actual = document.getElementById('fecha_calibracion_actual').value;
            const proxima_calibracion = document.getElementById('proxima_calibracion').value;
            
            // Validar ID Instrumento - espacios al inicio o final
            if (id_instrumento !== id_instrumento.trim()) {
                return marcarError('id_instrumento', 'No debe tener espacios al inicio o al final');
            }
            
            // Validar ID Instrumento - emojis
            if (contieneEmojis(id_instrumento)) {
                return marcarError('id_instrumento', 'No se permiten emojis en este campo');
            }
            
            // Validar ID Instrumento - scripts maliciosos
            if (contieneScriptMalicioso(id_instrumento)) {
                return marcarError('id_instrumento', 'Contenido malicioso detectado');
            }
            
            // Validar ID Instrumento - caracteres
            if (!esTextoValido(id_instrumento)) {
                return marcarError('id_instrumento', 'Solo se permiten letras, números, espacios, guiones, puntos, grados y paréntesis');
            }
            
            // Validar ID Instrumento - longitud
            if (id_instrumento.length > 100) {
                return marcarError('id_instrumento', 'Excede 100 caracteres');
            }
            
            // Validar Última Calibración - vacía
            if (!ultima_calibracion) {
                return marcarError('ultima_calibracion', 'Este campo es obligatorio');
            }
            
            // Validar Última Calibración - formato
            const fechaUltima = new Date(ultima_calibracion);
            if (isNaN(fechaUltima.getTime())) {
                return marcarError('ultima_calibracion', 'No es una fecha válida');
            }
            
            // Validar Última Calibración - no puede ser futura
            const fechaHoy = new Date();
            fechaHoy.setHours(0, 0, 0, 0);
            if (fechaUltima > fechaHoy) {
                return marcarError('ultima_calibracion', 'La última calibración no puede ser una fecha futura');
            }
            
            // Validar Última Calibración - no muy antigua
            const fecha20AnosAtras = new Date();
            fecha20AnosAtras.setFullYear(fechaHoy.getFullYear() - 20);
            if (fechaUltima < fecha20AnosAtras) {
                return marcarError('ultima_calibracion', 'No puede ser mayor a 20 años en el pasado');
            }
            
            // Validar Fecha Calibración Actual - vacía
            if (!fecha_calibracion_actual) {
                return marcarError('fecha_calibracion_actual', 'Este campo es obligatorio');
            }
            
            // Validar Fecha Calibración Actual - formato
            const fechaActual = new Date(fecha_calibracion_actual);
            if (isNaN(fechaActual.getTime())) {
                return marcarError('fecha_calibracion_actual', 'No es una fecha válida');
            }
            
            // Validar Fecha Calibración Actual - no muy antigua
            if (fechaActual < fecha20AnosAtras) {
                return marcarError('fecha_calibracion_actual', 'No puede ser mayor a 20 años en el pasado');
            }
            
            // Validar Fecha Calibración Actual >= Última Calibración
            if (fechaActual < fechaUltima) {
                return marcarError('fecha_calibracion_actual', 'No puede ser anterior a la Última Calibración');
            }
            
            // Validar Estándar de Referencia - espacios al inicio o final
            if (estandar_referencia !== estandar_referencia.trim()) {
                return marcarError('estandar_referencia', 'No debe tener espacios al inicio o al final');
            }
            
            // Validar Estándar de Referencia - emojis
            if (contieneEmojis(estandar_referencia)) {
                return marcarError('estandar_referencia', 'No se permiten emojis en este campo');
            }
            
            // Validar Estándar de Referencia - scripts
            if (contieneScriptMalicioso(estandar_referencia)) {
                return marcarError('estandar_referencia', 'Contenido malicioso detectado');
            }
            
            // Validar Estándar de Referencia - caracteres
            if (!esTextoValido(estandar_referencia)) {
                return marcarError('estandar_referencia', 'Solo se permiten letras, números, espacios, guiones, puntos, grados y paréntesis');
            }
            
            // Validar Estándar de Referencia - longitud
            if (estandar_referencia.length > 100) {
                return marcarError('estandar_referencia', 'Excede 100 caracteres');
            }
            
            // Validar Lectura Antes - espacios al inicio o final
            if (lectura_antes !== lectura_antes.trim()) {
                return marcarError('lectura_antes', 'No debe tener espacios al inicio o al final');
            }
            
            // Validar Lectura Antes - emojis
            if (contieneEmojis(lectura_antes)) {
                return marcarError('lectura_antes', 'No se permiten emojis en este campo');
            }
            
            // Validar Lectura Antes - scripts
            if (contieneScriptMalicioso(lectura_antes)) {
                return marcarError('lectura_antes', 'Contenido malicioso detectado');
            }
            
            // Validar Lectura Antes - formato
            if (!esLecturaValida(lectura_antes)) {
                return marcarError('lectura_antes', 'Debe tener formato: número + unidad (ej: 10.2°C)');
            }
            
            // Validar Lectura Antes - longitud
            if (lectura_antes.length > 50) {
                return marcarError('lectura_antes', 'Excede 50 caracteres');
            }
            
            // Validar Lectura Después - espacios al inicio o final
            if (lectura_despues !== lectura_despues.trim()) {
                return marcarError('lectura_despues', 'No debe tener espacios al inicio o al final');
            }
            
            // Validar Lectura Después - emojis
            if (contieneEmojis(lectura_despues)) {
                return marcarError('lectura_despues', 'No se permiten emojis en este campo');
            }
            
            // Validar Lectura Después - scripts
            if (contieneScriptMalicioso(lectura_despues)) {
                return marcarError('lectura_despues', 'Contenido malicioso detectado');
            }
            
            // Validar Lectura Después - formato
            if (!esLecturaValida(lectura_despues)) {
                return marcarError('lectura_despues', 'Debe tener formato: número + unidad (ej: 10.0°C)');
            }
            
            // Validar Lectura Después - longitud
            if (lectura_despues.length > 50) {
                return marcarError('lectura_despues', 'Excede 50 caracteres');
            }
            
            // Validar Certificado - espacios al inicio o final
            if (certificado_asociado !== certificado_asociado.trim()) {
                return marcarError('certificado_asociado', 'No debe tener espacios al inicio o al final');
            }
            
            // Validar Certificado - emojis
            if (contieneEmojis(certificado_asociado)) {
                return marcarError('certificado_asociado', 'No se permiten emojis en este campo');
            }
            
            // Validar Certificado - scripts
            if (contieneScriptMalicioso(certificado_asociado)) {
                return marcarError('certificado_asociado', 'Contenido malicioso detectado');
            }
            
            // Validar Certificado - formato
            if (!esCertificadoValido(certificado_asociado)) {
                return marcarError('certificado_asociado', 'Debe ser alfanumérico con guiones (ej: CERT-2024-001)');
            }
            
            // Validar Certificado - longitud
            if (certificado_asociado.length > 100) {
                return marcarError('certificado_asociado', 'Excede 100 caracteres');
            }
            
            // Validar Próxima Calibración - vacía
            if (!proxima_calibracion) {
                return marcarError('proxima_calibracion', 'Este campo es obligatorio');
            }
            
            // Validar Próxima Calibración - formato
            const fechaProxima = new Date(proxima_calibracion);
            if (isNaN(fechaProxima.getTime())) {
                return marcarError('proxima_calibracion', 'No es una fecha válida');
            }
            
            // Validar Próxima Calibración - no muy futura
            const fecha10AnosAdelante = new Date();
            fecha10AnosAdelante.setFullYear(fechaHoy.getFullYear() + 10);
            if (fechaProxima > fecha10AnosAdelante) {
                return marcarError('proxima_calibracion', 'No puede ser mayor a 10 años en el futuro');
            }
            
            // Validar Próxima Calibración > Fecha Actual
            if (fechaProxima <= fechaActual) {
                return marcarError('proxima_calibracion', 'Debe ser posterior a la Calibración Actual');
            }
            
            // Validar Próxima Calibración > Última Calibración
            if (fechaProxima <= fechaUltima) {
                return marcarError('proxima_calibracion', 'Debe ser posterior a la Última Calibración');
            }
            
            // Si todas las validaciones pasaron, enviar formulario
            this.submit();
        });
    </script>
</body>
</html>
